<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wedding Frame</title>

    <link rel="stylesheet" href="index.css" />

    <script defer src="/__/firebase/10.7.1/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/10.7.1/firebase-storage-compat.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=false"></script>
  </head>
  <body>
    <div>
      <h1>Jelena i Igor</h1>
      <p>Podeli slike sa nama sa svadbe.</p>
      <p id="loading" style="display: none">Slike se ucitavaju...</p>
      <form onsubmit="writeToStorage(event)">
        <label for="imageUpload" class="form-button">Odaberite slike</label>
        <input
          type="file"
          id="imageUpload"
          name="imageUpload"
          multiple
          accept="image/*,video/*"
        />

        <hr class="horizontal-line" />

        <button type="submit" class="form-button">Upload</button>
      </form>
    </div>

    <script>
      function setEnabledState(form, enabled) {
        for (const element of form.elements) {
          element.disabled = !enabled;
        }
      }

      async function writeToStorage(e) {
        e.preventDefault();
        const form = e.target;
        const loadingElement = document.getElementById("loading");
        loadingElement.style.display = "block";

        try {
          const formData = new FormData(e.target);
          const filesToUpload = formData.getAll("imageUpload");

          // disable after we get all images
          setEnabledState(form, false);

          const promises = [];

          for (const file of filesToUpload) {
            const storageRef = firebase.storage().ref();
            const fileRef = storageRef.child("Jelena2024/" + file.name);
            promises.push(fileRef.put(file));
          }

          const results = await Promise.all(promises);

          const successfulResults = results.filter(
            (r) => r.state === "success"
          ).length;

          alert(`Successfully uploaded ${successfulResults} images!`);
        } catch (error) {
          console.error(error);
          alert("Failed to upload images!");
        } finally {
          setEnabledState(form, true);
          form.reset();
          loadingElement.style.display = "none";
        }
      }
    </script>
  </body>
</html>
